<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Game Jump @ por Raphael Giron</title>

    <script src="js/sprite.js"></script>

    <style>
    	canvas {
    		position: absolute;
    		top: 0px;
    		bottom: 0px;
    		left: 0px;
    		right: 0px;
    		margin: auto;
    	}
    </style>

</head>



<body>
  	<script>
  		
  		var canves, ctx, ALTURA, LARGURA, frames = 0, maxPulos = 3, velocidade = 6, estadoAtual, record, img,

        estados = {

            jogar: 0, // Trocar para start
            jogando: 1, // Trocar para playing
            perdeu: 2 // Trocar para gameover
        },

  		chao = {

  			y: 550,
  			altura: 50,
  			cor: "#e8da78",

  			desenha: function() {

  				ctx.fillStyle = this.cor;
  				ctx.fillRect(0, this.y, LARGURA, this.altura);
  			}
  		},

  		bloco = {

  			x: 50,
  			y: 0,
  			altura: spriteBoneco.altura,
  			largura: spriteBoneco.largura,
  			cor: "#ff9239",
  			gravidade: 1.6,
  			velocidade: 0,
  			forcaDoPulo: 23.6,
  			qtdPulos: 0,
            score: 0,

  			atualiza: function() {

  				this.velocidade += this.gravidade;
  				this.y += this.velocidade;

  				if(this.y > chao.y - this.altura && estadoAtual != estados.perdeu) {

  					this.y = chao.y - this.altura;
  					this.qtdPulos = 0;
                    this.velocidade = 0;
  				}
  			},

  			pula: function() {

  				if(this.qtdPulos < maxPulos) {
  					
  					this.velocidade = -this.forcaDoPulo;
  					this.qtdPulos++;
  				}
  			},

            reset: function() {

                this.velocidade = 0;
                this.y = 0;

                if(this.score > record) {

                    record = this.score;
                    localStorage.setItem("record", record);
                }

                this.score = 0;
            },

  			desenha: function() {

  				// ctx.fillStyle = this.cor;
  				// ctx.fillRect(this.x, this.y, this.altura, this.largura);

                spriteBoneco.desenha(this.x, this.y);
  			}
  		},

        obstaculos = {

            _barreira: [],
            cores: ["#ffbc1c", "#ff1c1c", "#ff85e1", "#52a7ff", "#78ff5d"],
            tempoInsere: 0,

            insere: function() {

                this._barreira.push({

                    x: LARGURA,
                    // largura: 30 + Math.floor(21 * Math.random()),
                    largura: 50,
                    altura: 30 + Math.floor(120 * Math.random()),
                    cor: this.cores[Math.floor(this.cores.length * Math.random())]
                });

                this.tempoInsere = 30 + Math.floor(21 * Math.random());
            },

            atualiza: function() {

                if(this.tempoInsere == 0) {

                    this.insere();
                } else {

                    this.tempoInsere--;
                }

                let length = this._barreira.length;

                for(var i = 0; i < length; i++) {

                    this._barreira[i].x -= velocidade;

                    if(bloco.x < this._barreira[i].x + this._barreira[i].largura &&
                       bloco.x + bloco.largura >= this._barreira[i].x &&
                       bloco.y + bloco.altura >= chao.y - this._barreira[i].altura) {

                        estadoAtual = estados.perdeu;   
                    }

                    if(this._barreira[i].x == 0) {

                        bloco.score++;
                    }

                    if(this._barreira[i].x <= -this._barreira[i].largura) {

                        // Apago item do array assim que sair da tela
                        this._barreira.splice(i, 1);
                        length --;
                        i --;
                    }
                }
            },

            limpa: function() {

                this._barreira = [];
            },

            desenha: function() {

                let length = this._barreira.length;

                for(var i = 0; i < length; i++) {
                    
                    ctx.fillStyle = this._barreira[i].cor;
                    ctx.fillRect(this._barreira[i].x, chao.y - this._barreira[i].altura, this._barreira[i].largura, this._barreira[i].altura);
                }
            }
        };

  		function main() {

  			ALTURA 	= window.innerHeight;
  			LARGURA = window.innerWidth;

  			if(LARGURA => 500) {

  				ALTURA	= 600;
  				LARGURA = 600;
  			}

  			canvas = document.createElement("canvas");
  			canvas.width = LARGURA;
  			canvas.height = ALTURA;
  			canvas.style.border = "1px solid #ccc";

  			ctx = canvas.getContext("2d");

  			document.body.appendChild(canvas);

        document.addEventListener("mousedown", clique);
        document.body.onkeyup = function(e) {
            
            // https://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
            if(e.keyCode === 32 || e.keyCode === 38 || e.keyCode === 87) {

                clique();
            }
        }

        estadoAtual = estados.jogar;

        record = localStorage.getItem("record");

        if(record == null) {

            record = 0;
        }

        img = new Image();
        img.src="i/sheet.png";

  			roda();
  		}

  		function clique(event) {

            switch(estadoAtual) {
                case estados.jogando:
                    bloco.pula();
                    break;

                case estados.jogar:
                    estadoAtual = estados.jogando;
                    break;

                case estados.perdeu:
                    estadoAtual = estados.jogar;
                    obstaculos.limpa();
                    bloco.reset();
            }
  		}

  		function roda() {

  			atualiza();
  			desenha();

  			window.requestAnimationFrame(roda);
  		}

  		function atualiza() {

  			frames++;

            bloco.atualiza();
            
            if(estadoAtual == estados.jogando) {

                obstaculos.atualiza();   
            }
  		}

  		function desenha() {

  			// ctx.fillStyle = "#80daff";
  			// ctx.fillRect(0, 0, LARGURA, ALTURA);

            bg.desenha(0, 0);

            ctx.fillStyle = "#fff";
            ctx.font = "50px Arial";
            ctx.fillText(bloco.score, 30, 68);

            switch(estadoAtual) {
                case estados.jogar:
                    ctx.fillStyle = "green";
                    ctx.fillRect(LARGURA / 2 -50, ALTURA / 2 -50, 100, 100);
                    break;

                case estados.perdeu:
                    ctx.fillStyle = "red";
                    ctx.fillRect(LARGURA / 2 -50, ALTURA / 2 -50, 100, 100);

                    ctx.save();
                    ctx.translate(LARGURA / 2, ALTURA / 2);
                    ctx.fillStyle = "#fff";

                    if(bloco.score > record) {

                        ctx.fillText("Novo Record!", -150, -65);
                    } else if(record < 10) {

                        ctx.fillText("Record " + record, -99, -65);
                    } else if(record >= 10 && record < 100) {

                        ctx.fillText("Record " + record, -112, -65);
                    } else {

                        ctx.fillText("Record " + record, -125, -65);
                    }
                    
                    if(bloco.score < 10) {
                        
                        ctx.fillText(bloco.score, -13, 19);
                    } else if(bloco.score >= 10 && bloco.score < 100) {
                        
                        ctx.fillText(bloco.score, -26, 19);
                    } else {
                        
                        ctx.fillText(bloco.score, -39, 19);
                    }
                    
                    ctx.restore();
                    break;

                case estados.jogando:
                    obstaculos.desenha();
            }

  			chao.desenha();
  			bloco.desenha();
  		}




  		// Inicializa o game
  		main();



  	</script>
</body>
</html>